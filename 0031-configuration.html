<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0031-configuration - The Bee RFC Book</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="0030-protocol-messages.html">0030-protocol-messages</a></li><li class="chapter-item expanded "><a href="0031-configuration.html" class="active">0031-configuration</a></li><li class="chapter-item expanded "><a href="0033-network.html">0033-network</a></li><li class="chapter-item expanded "><a href="0035-logging.html">0035-logging</a></li><li class="chapter-item expanded "><a href="0036-ternary.html">0036-ternary</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Bee RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <ul>
<li>Feature name: <code>configuration</code></li>
<li>Start date: 2020-05-06</li>
<li>RFC PR: <a href="https://github.com/iotaledger/bee-rfcs/pull/31">iotaledger/bee-rfcs#31</a></li>
<li>Bee issue: <a href="https://github.com/iotaledger/bee/issues/71">iotaledger/bee#71</a></li>
</ul>
<h1><a class="header" href="#summary" id="summary">Summary</a></h1>
<p>This RFC proposes a configuration pattern for Bee binary and library crates.</p>
<h1><a class="header" href="#motivation" id="motivation">Motivation</a></h1>
<p>This RFC contains a set of recommendations regarding configuration management in order to ensure consistency across the
different Bee crates.</p>
<h1><a class="header" href="#detailed-design" id="detailed-design">Detailed design</a></h1>
<h2><a class="header" href="#libraries" id="libraries">Libraries</a></h2>
<ul>
<li><a href="https://github.com/serde-rs/serde">serde</a>: the go-to framework for <strong>ser</strong>ializing and <strong>de</strong>serializing Rust data
structures efficiently and generically;</li>
<li><a href="https://github.com/alexcrichton/toml-rs">toml-rs</a>: a TOML encoding/decoding library for Rust with
serialization/deserialization on top of <code>serde</code>;</li>
</ul>
<h2><a class="header" href="#recommendations" id="recommendations">Recommendations</a></h2>
<p>With the following recommendations, one can:</p>
<ul>
<li>read a configuration builder from a file;</li>
<li>write a configuration to a file;</li>
<li>manually override fields of a configuration builder;</li>
<li>construct a configuration from a configuration builder;</li>
</ul>
<h3><a class="header" href="#configuration-builder" id="configuration-builder">Configuration Builder</a></h3>
<p>The <a href="https://rust-lang.github.io/api-guidelines/type-safety.html#c-builder">Builder</a> pattern is very common in Rust when
it comes to constructing complex objects like configurations.</p>
<p>A configuration builder type should:</p>
<ul>
<li>have a name suffixed by <code>ConfigBuilder</code>;</li>
<li>derive the following traits;
<ul>
<li><code>Default</code> to easily implement the <code>new</code> method as convention;</li>
<li><code>Deserialize</code>, from <code>serde</code>, to deserialize from a configuration file;</li>
</ul>
</li>
<li>provide a <code>new</code> method;</li>
<li>have <code>Option</code> fields;
<ul>
<li>if there is a configuration file, the fields should have the same names as the keys;</li>
</ul>
</li>
<li>provide setters to set/override the fields;</li>
<li>provide a <code>finish</code> method constructing the actual configuration object;</li>
<li>have default values defined as <code>const</code> and set with <code>Option::unwrap_or</code>/<code>Option::unwrap_or_else</code>;</li>
</ul>
<p>Here is a small example fitting all these requirements.</p>
<p><code>config.toml</code></p>
<pre><code class="language-toml">[snapshot]
meta_file_path  = &quot;./data/snapshot/mainnet.snapshot.meta&quot;
state_file_path = &quot;./data/snapshot/mainnet.snapshot.state&quot;
</code></pre>
<p><code>config.rs</code></p>
<pre><pre class="playpen"><code class="language-rust">
<span class="boring">#![allow(unused_variables)]
</span><span class="boring">fn main() {
</span>const DEFAULT_META_FILE_PATH: &amp;str = &quot;./data/snapshot/mainnet.snapshot.meta&quot;;
const DEFAULT_STATE_FILE_PATH: &amp;str = &quot;./data/snapshot/mainnet.snapshot.state&quot;;

#[derive(Default, Deserialize)]
pub struct SnapshotConfigBuilder {
    meta_file_path: Option&lt;String&gt;,
    state_file_path: Option&lt;String&gt;,
}

impl SnapshotConfigBuilder {
    pub fn new() -&gt; Self {
        Self::default()
    }

    pub fn meta_file_path(mut self, meta_file_path: String) -&gt; Self {
        self.meta_file_path.replace(meta_file_path);
        self
    }

    pub fn state_file_path(mut self, state_file_path: String) -&gt; Self {
        self.state_file_path.replace(state_file_path);
        self
    }

    pub fn finish(self) -&gt; SnapshotConfig {
        SnapshotConfig {
            meta_file_path: self.meta_file_path.unwrap_or(DEFAULT_META_FILE_PATH.to_string()),
            state_file_path: self.state_file_path.unwrap_or(DEFAULT_STATE_FILE_PATH.to_string()),
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3><a class="header" href="#configuration" id="configuration">Configuration</a></h3>
<p>A configuration type should:</p>
<ul>
<li>have a name suffixed by <code>Config</code>;</li>
<li>derive the following traits;
<ul>
<li><code>Clone</code>, since all configuration are most probably aggregated in a common configuration after reading from a file,
this trait is needed to give components a unique ownership of their own configuration;</li>
<li><code>Serialize</code> if the configuration is expected to be updated and saved;</li>
</ul>
</li>
<li>provide a <code>build</code> method that returns a new instance of the associated builder;</li>
<li>have the same fields with the same names, without <code>Option</code>, as the builder;</li>
<li>have no public fields;</li>
<li>provide setters/updaters only on fields that are expected to be updatable;</li>
<li>have getters or <code>pub(crate)</code> fields;</li>
</ul>
<p>Here is a small example fitting all these requirements:</p>
<p><code>config.toml</code></p>
<pre><code class="language-toml">[snapshot]
meta_file_path  = &quot;./data/snapshot/mainnet.snapshot.meta&quot;
state_file_path = &quot;./data/snapshot/mainnet.snapshot.state&quot;
</code></pre>
<p><code>config.rs</code></p>
<pre><pre class="playpen"><code class="language-rust">
<span class="boring">#![allow(unused_variables)]
</span><span class="boring">fn main() {
</span>#[derive(Clone)]
pub struct SnapshotConfig {
    meta_file_path: String,
    state_file_path: String,
}

impl SnapshotConfig {
    pub fn build() -&gt; SnapshotConfigBuilder {
      SnapshotConfig::new()
    }

    pub fn meta_file_path(&amp;self) -&gt; &amp;String {
        &amp;self.meta_file_path
    }

    pub fn state_file_path(&amp;self) -&gt; &amp;String {
        &amp;self.state_file_path
    }
}

<span class="boring">}
</span></code></pre></pre>
<h3><a class="header" href="#read-a-configuration-builder-from-a-file" id="read-a-configuration-builder-from-a-file">Read a configuration builder from a file</a></h3>
<pre><pre class="playpen"><code class="language-rust">
<span class="boring">#![allow(unused_variables)]
</span><span class="boring">fn main() {
</span>let config_builder = match fs::read_to_string(&quot;config.toml&quot;) {
    Ok(toml) =&gt; match toml::from_str::&lt;SnapshotConfigBuilder&gt;(&amp;toml) {
        Ok(config_builder) =&gt; config_builder,
        Err(e) =&gt; {
            // Handle error
        }
    },
    Err(e) =&gt; {
        // Handle error
    }
};

// Override fields if necessary e.g. with CLI arguments.

let config = config_builder.finish();
<span class="boring">}
</span></code></pre></pre>
<h3><a class="header" href="#write-a-configuration-to-a-file" id="write-a-configuration-to-a-file">Write a configuration to a file</a></h3>
<pre><pre class="playpen"><code class="language-rust">
<span class="boring">#![allow(unused_variables)]
</span><span class="boring">fn main() {
</span>match toml::to_string(&amp;config) {
    Ok(toml) =&gt; match fs::File::create(&quot;config.toml&quot;) {
        Ok(mut file) =&gt; {
            if let Err(e) = file.write_all(toml.as_bytes()) {
                // Handle error
            }
        }
        Err(e) =&gt; {
            // Handle error
        }
    },
    Err(e) =&gt; {
        // Handle error
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3><a class="header" href="#sub-configuration" id="sub-configuration">Sub-configuration</a></h3>
<p>It is also very easy to create sub-configurations by nesting configuration builders and configurations.</p>
<p><code>config.toml</code></p>
<pre><code class="language-toml">[snapshot]
[snapshot.local]
meta_file_path  = &quot;./data/snapshot/local/mainnet.snapshot.meta&quot;
state_file_path = &quot;./data/snapshot/local/mainnet.snapshot.state&quot;
[snapshot.global]
file_path       = &quot;./data/snapshot/global/mainnet.txt&quot;
</code></pre>
<p><code>config.rs</code></p>
<pre><pre class="playpen"><code class="language-rust">
<span class="boring">#![allow(unused_variables)]
</span><span class="boring">fn main() {
</span>#[derive(Default, Deserialize)]
pub struct LocalSnapshotConfigBuilder {
    meta_file_path: Option&lt;String&gt;,
    state_file_path: Option&lt;String&gt;,
}

#[derive(Default, Deserialize)]
pub struct GlobalSnapshotConfigBuilder {
    file_path: Option&lt;String&gt;,
}

#[derive(Default, Deserialize)]
pub struct SnapshotConfigBuilder {
    local: LocalSnapshotConfigBuilder,
    global: GlobalSnapshotConfigBuilder,
}

impl SnapshotConfigBuilder {
    pub fn new() -&gt; Self {
        Self::default()
    }

    // Setters

    pub fn finish(self) -&gt; SnapshotConfig {
        SnapshotConfig {
            local: LocalSnapshotConfig {
                meta_file_path: self
                    .local
                    .meta_file_path
                    .unwrap_or(DEFAULT_LOCAL_SNAPSHOT_META_FILE_PATH.to_string()),
                state_file_path: self
                    .local
                    .state_file_path
                    .unwrap_or(DEFAULT_LOCAL_SNAPSHOT_STATE_FILE_PATH.to_string()),
            },
            global: GlobalSnapshotConfig {
                file_path: self
                    .global
                    .file_path
                    .unwrap_or(DEFAULT_GLOBAL_SNAPSHOT_FILE_PATH.to_string()),
            },
        }
    }
}
#[derive(Clone)]
pub struct LocalSnapshotConfig {
    meta_file_path: String,
    state_file_path: String,
}

#[derive(Clone)]
pub struct GlobalSnapshotConfig {
    file_path: String,
}

#[derive(Clone)]
pub struct SnapshotConfig {
    local: LocalSnapshotConfig,
    global: GlobalSnapshotConfig,
}

// Impl

<span class="boring">}
</span></code></pre></pre>
<h1><a class="header" href="#drawbacks" id="drawbacks">Drawbacks</a></h1>
<p>No specific drawback with this approach.</p>
<h1><a class="header" href="#rationale-and-alternatives" id="rationale-and-alternatives">Rationale and alternatives</a></h1>
<p>Many configuration formats are usually considered:</p>
<ul>
<li><a href="https://github.com/toml-lang/toml">TOML</a></li>
<li><a href="https://www.json.org/json-en.html">JSON</a></li>
<li><a href="https://github.com/lightbend/config/blob/master/HOCON.md">HOCON</a></li>
<li><a href="https://yaml.org/">YAML</a></li>
<li><a href="https://www.w3.org/XML/">XML</a></li>
<li><a href="https://github.com/ron-rs/ron">RON</a></li>
</ul>
<p>This RFC and its expected implementations are choosing <code>TOML</code> as a first default configuration format because it is the
preferred option in the Rust ecosystem. However, it is not excluded by this RFC that other formats may be provided in
the future, <code>serde</code> making it very easy to support other formats. It is also important to note that TOML only provides
a limited amount of layers of nesting due to its non-recursive syntax, which may eventually become an issue.</p>
<p><code>Serde</code> itself has been chosen because it is the standard for serialization/deserialization in Rust.</p>
<h1><a class="header" href="#unresolved-questions" id="unresolved-questions">Unresolved questions</a></h1>
<p>In case of binary crates, e.g.<code>bee-node</code>, configuration with CLI arguments is not described in this RFC but everything
is already set up to support it seamlessly. The builder setters allow setting fields or overriding fields that may
have already pre-filled by the parsing of a configuration file. A CLI parser library like
<a href="https://github.com/clap-rs/clap">clap</a> may be used on top of the builders;</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="0030-protocol-messages.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="0033-network.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="0030-protocol-messages.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="0033-network.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
